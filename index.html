<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>よちゲーム！</title>
<style>
  body {
    margin: 0;
    font-family: sans-serif;
    background-color: #f0f2f5;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  h1 {
      color: #333;
      margin-bottom: 5px;
  }

  #game-area {
    width: 90%;
    max-width: 400px;
    height: 300px;
    background-color: #fff;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
    border: 3px solid #ddd;
    transition: border-color 0.1s, background-color 0.1s;
    transform: translateZ(0);
    will-change: background-color, border-color;
  }

  /* 画像を絶対配置で重ねる（透明人間作戦） */
  .game-img {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: auto;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      opacity: 0;
      transition: none;
      pointer-events: none;
      will-change: opacity;
  }

  .game-img.show {
      opacity: 1;
  }

  #game-area.active {
    cursor: pointer;
  }
  
  #game-area.miss-flash {
    border-color: #ff3838 !important;
    background-color: #ffecec !important;
  }
  
  #game-area.hit-flash {
    border-color: #2ecc71 !important;
    background-color: #e8f8f0 !important;
  }

  #start-btn {
    margin-top: 30px;
    padding: 15px 40px;
    font-size: 1.2rem;
    font-weight: bold;
    color: #fff;
    background: #ccc;
    border: none;
    border-radius: 50px;
    cursor: default;
    transition: all 0.3s;
  }
  
  #start-btn.ready {
    background: linear-gradient(45deg, #ff6b6b, #ff8e53);
    box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
    cursor: pointer;
  }

  #start-btn:active {
    transform: scale(0.95);
  }
  #start-btn:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
  }

  #result-area {
    margin-top: 20px;
    text-align: center;
    display: none;
  }
  .result-text {
      font-size: 1.1rem;
      margin: 5px 0;
  }
  .score {
      font-size: 1.8rem;
      font-weight: bold;
      color: #ff6b6b;
  }

  #status-message {
      font-weight: bold;
      margin-bottom: 10px;
      height: 20px;
      color: #333;
  }

  #countdown {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 4rem;
      color: #ff6b6b;
      display: none;
      z-index: 10;
  }
</style>
</head>
<body>

<h1>よちゲーム！</h1>

<div id="status-message">画像をデコード中...</div>

<div id="game-area">
    <img id="img-target" class="game-img" src="target.png" alt="彼女">
    <img id="img-other1" class="game-img" src="other1.png" alt="違う人1">
    <img id="img-other2" class="game-img" src="other2.png" alt="違う人2">
    <img id="img-other3" class="game-img" src="other3.png" alt="違う人3">
    <div id="countdown"></div>
</div>

<button id="start-btn" disabled>読み込み中...</button>

<div id="result-area">
  <h2>結果発表</h2>
  <p class="result-text">平均反応速度: <span id="avg-speed" class="score">0.000</span> 秒</p>
  <p class="result-text">お手つき回数: <span id="miss-count" class="score">0</span> 回</p>
</div>


<script>
  const gameArea = document.getElementById('game-area');
  const startBtn = document.getElementById('start-btn');
  const resultArea = document.getElementById('result-area');
  const avgSpeedSpan = document.getElementById('avg-speed');
  const missCountSpan = document.getElementById('miss-count');
  const countdownSpan = document.getElementById('countdown');
  const statusMessage = document.getElementById('status-message');
  
  const targetImgEl = document.getElementById('img-target');
  const otherImgEls = [
      document.getElementById('img-other1'),
      document.getElementById('img-other2'),
      document.getElementById('img-other3')
  ];
  const allImgEls = [targetImgEl, ...otherImgEls];

  let isPlaying = false;
  let waitingForReaction = false;
  let currentTargetIsTarget = false;
  let startTime = 0;
  let reactionTimes = [];
  let missCount = 0;
  let trialCount = 0;
  const maxTrials = 10;
  let trialTimeout;

  async function prepareImages() {
      const promises = allImgEls.map(img => {
          if (img.decode) {
              return img.decode().catch(() => console.error("decode error"));
          } else {
              return new Promise(resolve => {
                  if(img.complete) resolve();
                  else img.onload = resolve;
              });
          }
      });
      await Promise.all(promises);
      startBtn.disabled = false;
      startBtn.classList.add('ready');
      startBtn.textContent = "スタート！";
      statusMessage.textContent = "準備完了！";
  }
  prepareImages();

  startBtn.addEventListener('click', startGame);
  gameArea.addEventListener('touchstart', handleTap); 
  gameArea.addEventListener('mousedown', handleTap); 

  function startGame() {
    if (isPlaying) return;
    
    startBtn.disabled = true;
    startBtn.classList.remove('ready');
    startBtn.textContent = "ゲーム中...";
    resultArea.style.display = 'none';
    reactionTimes = [];
    missCount = 0;
    trialCount = 0;
    hideAllImages();
    statusMessage.textContent = '準備中...';
    
    let count = 3;
    countdownSpan.style.display = 'block';
    countdownSpan.textContent = count;
    
    const countTimer = setInterval(() => {
        count--;
        if(count > 0) {
            countdownSpan.textContent = count;
        } else {
            clearInterval(countTimer);
            countdownSpan.style.display = 'none';
            isPlaying = true;
            nextTrial();
        }
    }, 1000);
  }

  function hideAllImages() {
      allImgEls.forEach(img => img.classList.remove('show'));
  }

  function nextTrial() {
    if (trialCount >= maxTrials) {
      endGame();
      return;
    }

    trialCount++;
    waitingForReaction = false;
    gameArea.classList.remove('active', 'hit-flash', 'miss-flash');
    hideAllImages();

    // ▼▼▼ 修正: 溜め時間を0.2秒〜0.5秒の超高速に設定 ▼▼▼
    const waitTime = Math.random() * 300 + 200; 
    statusMessage.textContent = `第 ${trialCount} 問`;

    trialTimeout = setTimeout(() => {
      currentTargetIsTarget = Math.random() < 0.5;
      
      let selectedImg;
      if (currentTargetIsTarget) {
        selectedImg = targetImgEl;
      } else {
        selectedImg = otherImgEls[Math.floor(Math.random() * otherImgEls.length)];
      }
      
      selectedImg.classList.add('show');
      gameArea.classList.add('active');
      
      requestAnimationFrame(() => {
          setTimeout(() => {
              startTime = Date.now();
              waitingForReaction = true;
              startMissTimeout();
          }, 0);
      });

    }, waitTime);
  }

  function startMissTimeout() {
      // 0.8秒制限
      trialTimeout = setTimeout(() => {
          if(waitingForReaction) {
            waitingForReaction = false;
            
            if(currentTargetIsTarget) {
                missCount++;
                statusMessage.textContent = '遅い！'; 
                flashArea('miss-flash'); 
            } else {
                statusMessage.textContent = 'OK';
            }
            // ▼▼▼ 修正: 次の問題へ移るまでの時間（余韻）を0.2秒に短縮 ▼▼▼
            setTimeout(nextTrial, 200);
          }
      }, 800);
  }

  function handleTap(e) {
    if (e.type === 'mousedown' && e.button !== 0) return; 

    e.preventDefault();
    if (!isPlaying || !waitingForReaction) return;

    const endTime = Date.now();
    const reactionTime = (endTime - startTime) / 1000;
    waitingForReaction = false;
    clearTimeout(trialTimeout);

    if (currentTargetIsTarget) {
      reactionTimes.push(reactionTime);
      statusMessage.textContent = reactionTime.toFixed(3) + '秒';
      flashArea('hit-flash');
    } else {
      missCount++;
      statusMessage.textContent = 'ミス！';
      flashArea('miss-flash');
    }
    
    // ▼▼▼ 修正: 次の問題へ移るまでの時間（余韻）を0.2秒に短縮 ▼▼▼
    setTimeout(nextTrial, 200);
  }
  
  function flashArea(type) {
      gameArea.classList.add(type);
      setTimeout(() => {
          gameArea.classList.remove(type);
      }, 150); // フラッシュも短く150msに
  }

  function endGame() {
    isPlaying = false;
    startBtn.disabled = false;
    startBtn.classList.add('ready');
    startBtn.textContent = "もう一度";
    
    let avgSpeed = 0;
    if (reactionTimes.length > 0) {
        const sum = reactionTimes.reduce((a, b) => a + b, 0);
        avgSpeed = sum / reactionTimes.length;
    }

    avgSpeedSpan.textContent = avgSpeed.toFixed(3);
    missCountSpan.textContent = missCount;
    resultArea.style.display = 'block';
    statusMessage.textContent = '終了';
  }
</script>
</body>
</html>
