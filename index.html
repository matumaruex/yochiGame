<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>よちゲーム！</title>
<style>
  body {
    margin: 0;
    font-family: sans-serif;
    background-color: #f0f2f5;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  h1 {
      color: #333;
      margin-bottom: 5px;
  }

  #game-area {
    width: 90%;
    max-width: 400px;
    height: 300px;
    background-color: #fff;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
    position: relative;
    overflow: hidden;
    border: 3px solid #ddd;
    transition: border-color 0.1s, background-color 0.1s;
    /* 画像のレンダリングを最適化 */
    transform: translateZ(0); 
  }

  #game-area img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 12px;
      display: none;
      pointer-events: none;
  }

  #game-area.active {
    cursor: pointer;
  }
  
  #game-area.miss-flash {
    border-color: #ff3838 !important;
    background-color: #ffecec !important;
  }
  
  #game-area.hit-flash {
    border-color: #2ecc71 !important;
    background-color: #e8f8f0 !important;
  }

  #start-btn {
    margin-top: 30px;
    padding: 15px 40px;
    font-size: 1.2rem;
    font-weight: bold;
    color: #fff;
    background: #ccc; /* ロード完了までグレー */
    border: none;
    border-radius: 50px;
    box-shadow: none;
    cursor: default;
    transition: all 0.3s;
  }
  
  /* ロード完了後のボタンスタイル */
  #start-btn.ready {
    background: linear-gradient(45deg, #ff6b6b, #ff8e53);
    box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
    cursor: pointer;
  }

  #start-btn:active {
    transform: scale(0.95);
  }
  #start-btn:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
  }

  #result-area {
    margin-top: 20px;
    text-align: center;
    display: none;
  }
  .result-text {
      font-size: 1.1rem;
      margin: 5px 0;
  }
  .score {
      font-size: 1.8rem;
      font-weight: bold;
      color: #ff6b6b;
  }

  #status-message {
      font-weight: bold;
      margin-bottom: 10px;
      height: 20px;
      color: #333;
  }

  #countdown {
      position: absolute;
      font-size: 4rem;
      color: #ff6b6b;
      display: none;
  }
</style>
</head>
<body>

<h1>よちゲーム！</h1>

<div id="status-message">画像を読み込んでいます...</div>

<div id="game-area">
    <img id="display-image" src="" alt="表示画像">
    <div id="countdown"></div>
</div>

<button id="start-btn" disabled>読み込み中...</button>

<div id="result-area">
  <h2>結果発表</h2>
  <p class="result-text">平均反応速度: <span id="avg-speed" class="score">0.000</span> 秒</p>
  <p class="result-text">お手つき回数: <span id="miss-count" class="score">0</span> 回</p>
</div>


<script>
  // ▼▼▼ 画像設定 ▼▼▼
  const targetImages = ['target.png']; 
  const otherImages = ['other1.png', 'other2.png', 'other3.png'];
  // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

  const gameArea = document.getElementById('game-area');
  const displayImage = document.getElementById('display-image');
  const startBtn = document.getElementById('start-btn');
  const resultArea = document.getElementById('result-area');
  const avgSpeedSpan = document.getElementById('avg-speed');
  const missCountSpan = document.getElementById('miss-count');
  const countdownSpan = document.getElementById('countdown');
  const statusMessage = document.getElementById('status-message');

  let isPlaying = false;
  let waitingForReaction = false;
  let currentTargetIsTarget = false;
  let startTime = 0;
  let reactionTimes = [];
  let missCount = 0;
  let trialCount = 0;
  const maxTrials = 10;
  let trialTimeout;

  // --- 画像先読み処理 (ここが修正ポイント) ---
  const allImagePaths = [...targetImages, ...otherImages];
  let loadedCount = 0;
  const preloadedImages = [];

  function preloadImages() {
    if(allImagePaths.length === 0) {
        enableStartBtn();
        return;
    }

    allImagePaths.forEach(path => {
        const img = new Image();
        img.src = path;
        img.onload = () => {
            loadedCount++;
            if(loadedCount === allImagePaths.length) {
                enableStartBtn();
            }
        };
        img.onerror = () => {
            // 画像が見つからなくてもとりあえず進める
            console.error("画像が見つかりません: " + path);
            loadedCount++;
            if(loadedCount === allImagePaths.length) {
                enableStartBtn();
            }
        };
        preloadedImages.push(img); // メモリに保持
    });
  }

  function enableStartBtn() {
      startBtn.disabled = false;
      startBtn.classList.add('ready');
      startBtn.textContent = "スタート！";
      statusMessage.textContent = "準備完了！";
  }

  // ページ読み込み時に実行
  preloadImages();
  // ------------------------------------------

  startBtn.addEventListener('click', startGame);
  gameArea.addEventListener('touchstart', handleTap); 
  gameArea.addEventListener('mousedown', handleTap); 

  function startGame() {
    if (isPlaying) return;
    
    startBtn.disabled = true;
    startBtn.classList.remove('ready');
    startBtn.textContent = "ゲーム中...";
    resultArea.style.display = 'none';
    reactionTimes = [];
    missCount = 0;
    trialCount = 0;
    displayImage.style.display = 'none';
    statusMessage.textContent = '準備中...';
    
    let count = 3;
    countdownSpan.style.display = 'block';
    countdownSpan.textContent = count;
    
    const countTimer = setInterval(() => {
        count--;
        if(count > 0) {
            countdownSpan.textContent = count;
        } else {
            clearInterval(countTimer);
            countdownSpan.style.display = 'none';
            isPlaying = true;
            nextTrial();
        }
    }, 1000);
  }

  function nextTrial() {
    if (trialCount >= maxTrials) {
      endGame();
      return;
    }

    trialCount++;
    waitingForReaction = false;
    gameArea.classList.remove('active', 'hit-flash', 'miss-flash');
    displayImage.style.display = 'none';

    const waitTime = Math.random() * 2000 + 1000;
    statusMessage.textContent = `第 ${trialCount} 問目...`;

    trialTimeout = setTimeout(() => {
      currentTargetIsTarget = Math.random() < 0.5;
      
      let imageUrl;
      if (currentTargetIsTarget) {
        imageUrl = targetImages[Math.floor(Math.random() * targetImages.length)];
      } else {
        imageUrl = otherImages[Math.floor(Math.random() * otherImages.length)];
      }
      
      // 画像ソースをセットして表示
      displayImage.src = imageUrl;
      displayImage.style.display = 'block';

      gameArea.classList.add('active');
      
      // 表示タイミングをブラウザの描画に合わせる（より正確に）
      requestAnimationFrame(() => {
          setTimeout(() => {
              startTime = Date.now();
              waitingForReaction = true;
              
              // 見逃し判定（1秒）
              startMissTimeout();
          }, 0);
      });

    }, waitTime);
  }

  function startMissTimeout() {
      trialTimeout = setTimeout(() => {
          if(waitingForReaction) {
            waitingForReaction = false;
            
            if(currentTargetIsTarget) {
                missCount++;
                statusMessage.textContent = '見逃し！ミスです';
                flashArea('miss-flash'); 
            } else {
                statusMessage.textContent = 'スルー成功！';
            }
            setTimeout(nextTrial, 700);
          }
      }, 1000); // 1秒設定
  }

  function handleTap(e) {
    if (e.type === 'mousedown' && e.button !== 0) return; 

    e.preventDefault();
    if (!isPlaying || !waitingForReaction) return;

    const endTime = Date.now();
    const reactionTime = (endTime - startTime) / 1000;
    waitingForReaction = false;
    clearTimeout(trialTimeout);

    if (currentTargetIsTarget) {
      reactionTimes.push(reactionTime);
      statusMessage.textContent = 'ナイス！ ' + reactionTime.toFixed(3) + '秒';
      flashArea('hit-flash');
    } else {
      missCount++;
      statusMessage.textContent = 'お手つき！ミスです';
      flashArea('miss-flash');
    }
    
    setTimeout(nextTrial, 700);
  }
  
  function flashArea(type) {
      gameArea.classList.add(type);
      setTimeout(() => {
          gameArea.classList.remove(type);
      }, 300);
  }

  function endGame() {
    isPlaying = false;
    startBtn.disabled = false;
    startBtn.classList.add('ready');
    startBtn.textContent = "もう一度チャレンジ";
    
    let avgSpeed = 0;
    if (reactionTimes.length > 0) {
        const sum = reactionTimes.reduce((a, b) => a + b, 0);
        avgSpeed = sum / reactionTimes.length;
    }

    avgSpeedSpan.textContent = avgSpeed.toFixed(3);
    missCountSpan.textContent = missCount;
    resultArea.style.display = 'block';
    statusMessage.textContent = 'ゲーム終了！';
  }
</script>
</body>
</html>
