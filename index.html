<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚ˆã¡ã‚²ãƒ¼ãƒ ï¼ğŸ¶</title>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
<style>
  /* â–¼â–¼â–¼ ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ãƒãƒ¡ãƒ©ãƒ‹ã‚¢ãƒ³é¢¨ã«å¤‰æ›´ â–¼â–¼â–¼ */
  body {
    margin: 0;
    font-family: 'M PLUS Rounded 1c', sans-serif; /* ä¸¸ã‚´ã‚·ãƒƒã‚¯ä½“ */
    background-color: #fff8e7; /* ã‚¯ãƒªãƒ¼ãƒ è‰²ã®èƒŒæ™¯ */
    background-image: radial-gradient(#fff0d0 10%, transparent 10%); /* ã†ã£ã™ã‚‰ãƒ‰ãƒƒãƒˆæŸ„ */
    background-size: 20px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    color: #5a4a42; /* æ–‡å­—è‰²ã‚’å„ªã—ã„èŒ¶è‰²ã« */
  }

  h1 {
      color: #8d5524; /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ¿ƒã„èŒ¶è‰²ã« */
      margin-bottom: 10px;
      font-size: 1.8rem;
      text-shadow: 2px 2px 0px #fff;
  }

  #game-container {
      background: rgba(255, 255, 255, 0.8);
      padding: 20px;
      border-radius: 30px;
      box-shadow: 0 8px 20px rgba(141, 85, 36, 0.15); /* ãµã‚“ã‚ã‚Šã—ãŸå½± */
      text-align: center;
  }

  #game-area {
    width: 300px;
    height: 300px;
    background-color: #fff;
    border-radius: 25px; /* è§’ã‚’ã‚‚ã£ã¨ä¸¸ã */
    border: 5px solid #e6cba8; /* ãƒãƒ¡è‰²ã®æ ç·š */
    box-shadow: inset 0 0 20px rgba(230, 203, 168, 0.5); /* å†…å´ã‚‚ãµã‚ã£ã¨ */
    position: relative;
    overflow: hidden;
    margin: 0 auto;
    /* GPUã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ */
    transform: translateZ(0);
    will-change: background-color, border-color;
    transition: all 0.1s;
  }

  /* ç”»åƒã‚’çµ¶å¯¾é…ç½®ã§é‡ã­ã‚‹ï¼ˆé€æ˜äººé–“ä½œæˆ¦ï¼‰ */
  .game-img {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      margin: auto;
      max-width: 90%; /* æ å†…ã«å°‘ã—ä½™ç™½ã‚’æŒãŸã›ã‚‹ */
      max-height: 90%;
      object-fit: contain;
      opacity: 0;
      transition: none;
      pointer-events: none;
      will-change: opacity;
      border-radius: 15px;
  }

  .game-img.show {
      opacity: 1;
  }

  #game-area.active {
    cursor: pointer;
    border-color: #ffb347; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã¯å°‘ã—æ˜ã‚‹ã„ã‚ªãƒ¬ãƒ³ã‚¸ */
  }
  
  /* ãƒŸã‚¹æ™‚ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆèµ¤ç³»ã ã‘ã©å°‘ã—æŸ”ã‚‰ã‹ãï¼‰ */
  #game-area.miss-flash {
    border-color: #ff7f7f !important;
    background-color: #fff0f0 !important;
  }
  
  /* æ­£è§£æ™‚ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆç·‘ç³»ã ã‘ã©å°‘ã—æŸ”ã‚‰ã‹ãï¼‰ */
  #game-area.hit-flash {
    border-color: #90e0aa !important;
    background-color: #f0fff4 !important;
  }

  #start-btn {
    margin-top: 25px;
    padding: 15px 50px;
    font-size: 1.2rem;
    font-weight: bold;
    color: #fff;
    background: #d4c4b7; /* æº–å‚™ä¸­ã¯ãƒ™ãƒ¼ã‚¸ãƒ¥ */
    border: none;
    border-radius: 50px; /* å®Œå…¨ã«ä¸¸ã */
    cursor: default;
    transition: all 0.3s;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    box-shadow: 0 4px 0 #bba99d; /* ç«‹ä½“çš„ãªãƒœã‚¿ãƒ³ */
  }
  
  #start-btn.ready {
    /* æº–å‚™å®Œäº†æ™‚ã¯ãƒãƒ¡ã£ã½ã„ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
    background: linear-gradient(45deg, #ffb347, #ffcc33);
    box-shadow: 0 4px 0 #e5a23d;
    cursor: pointer;
  }

  #start-btn:active {
    transform: translateY(4px); /* æŠ¼ã—ãŸã¨ãã«æ²ˆã‚€æ¼”å‡º */
    box-shadow: none;
  }
  #start-btn:disabled {
      opacity: 0.7;
      cursor: default;
      transform: none;
      box-shadow: none;
  }

  #result-area {
    margin-top: 20px;
    display: none;
  }
  .result-text {
      font-size: 1.1rem;
      margin: 5px 0;
  }
  .score {
      font-size: 2rem;
      font-weight: bold;
      color: #ff8ba7; /* ãƒ”ãƒ³ã‚¯è‰² */
  }

  #status-message {
      font-weight: bold;
      margin-bottom: 15px;
      height: 25px;
      color: #8d5524;
      font-size: 1.1rem;
  }

  #countdown {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 5rem;
      color: #ffb347;
      text-shadow: 3px 3px 0 #fff;
      display: none;
      z-index: 10;
  }
</style>
</head>
<body>

<div id="game-container">
    <h1>ğŸ¾ ã‚ˆã¡ã‚²ãƒ¼ãƒ ï¼ ğŸ¶</h1>

    <div id="status-message">æº–å‚™ã—ã¦ã‚‹ãƒ¯ãƒ³...ğŸ©</div>

    <div id="game-area">
        <img id="img-target" class="game-img" src="target.png" alt="å½¼å¥³">
        <img id="img-other1" class="game-img" src="other1.png" alt="é•ã†äºº1">
        <img id="img-other2" class="game-img" src="other2.png" alt="é•ã†äºº2">
        <img id="img-other3" class="game-img" src="other3.png" alt="é•ã†äºº3">
        <div id="countdown"></div>
    </div>

    <button id="start-btn" disabled>èª­ã¿è¾¼ã¿ä¸­...</button>

    <div id="result-area">
      <h2>âœ¨ çµæœç™ºè¡¨ âœ¨</h2>
      <p class="result-text">å¹³å‡åå¿œé€Ÿåº¦: <span id="avg-speed" class="score">0.000</span> ç§’</p>
      <p class="result-text">ãŠæ‰‹ã¤ãå›æ•°: <span id="miss-count" class="score">0</span> å›</p>
    </div>
</div>


<script>
  const gameArea = document.getElementById('game-area');
  const startBtn = document.getElementById('start-btn');
  const resultArea = document.getElementById('result-area');
  const avgSpeedSpan = document.getElementById('avg-speed');
  const missCountSpan = document.getElementById('miss-count');
  const countdownSpan = document.getElementById('countdown');
  const statusMessage = document.getElementById('status-message');
  
  const targetImgEl = document.getElementById('img-target');
  const otherImgEls = [
      document.getElementById('img-other1'),
      document.getElementById('img-other2'),
      document.getElementById('img-other3')
  ];
  const allImgEls = [targetImgEl, ...otherImgEls];

  let isPlaying = false;
  let waitingForReaction = false;
  let currentTargetIsTarget = false;
  let startTime = 0;
  let reactionTimes = [];
  let missCount = 0;
  let trialCount = 0;
  const maxTrials = 10;
  let trialTimeout;

  async function prepareImages() {
      const promises = allImgEls.map(img => {
          if (img.decode) {
              return img.decode().catch(() => console.error("decode error"));
          } else {
              return new Promise(resolve => {
                  if(img.complete) resolve();
                  else img.onload = resolve;
              });
          }
      });
      await Promise.all(promises);
      startBtn.disabled = false;
      startBtn.classList.add('ready');
      startBtn.textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆï¼ğŸ¾";
      statusMessage.textContent = "æº–å‚™OKã ãƒ¯ãƒ³ï¼âœ¨";
  }
  prepareImages();

  startBtn.addEventListener('click', startGame);
  gameArea.addEventListener('touchstart', handleTap); 
  gameArea.addEventListener('mousedown', handleTap); 

  function startGame() {
    if (isPlaying) return;
    
    startBtn.disabled = true;
    startBtn.classList.remove('ready');
    startBtn.textContent = "ã‚²ãƒ¼ãƒ ä¸­...ğŸ©";
    resultArea.style.display = 'none';
    reactionTimes = [];
    missCount = 0;
    trialCount = 0;
    hideAllImages();
    statusMessage.textContent = 'é›†ä¸­ã—ã¦ã­...';
    
    let count = 3;
    countdownSpan.style.display = 'block';
    countdownSpan.textContent = count;
    
    const countTimer = setInterval(() => {
        count--;
        if(count > 0) {
            countdownSpan.textContent = count;
        } else {
            clearInterval(countTimer);
            countdownSpan.style.display = 'none';
            isPlaying = true;
            nextTrial();
        }
    }, 1000);
  }

  function hideAllImages() {
      allImgEls.forEach(img => img.classList.remove('show'));
  }

  function nextTrial() {
    if (trialCount >= maxTrials) {
      endGame();
      return;
    }

    trialCount++;
    waitingForReaction = false;
    gameArea.classList.remove('active', 'hit-flash', 'miss-flash');
    hideAllImages();

    // æºœã‚ï¼š0.2ç§’ã€œ0.5ç§’
    const waitTime = Math.random() * 300 + 200; 
    statusMessage.textContent = `ç¬¬ ${trialCount} å•ç›® ğŸ¾`;

    trialTimeout = setTimeout(() => {
      currentTargetIsTarget = Math.random() < 0.5;
      
      let selectedImg;
      if (currentTargetIsTarget) {
        selectedImg = targetImgEl;
      } else {
        selectedImg = otherImgEls[Math.floor(Math.random() * otherImgEls.length)];
      }
      
      selectedImg.classList.add('show');
      gameArea.classList.add('active');
      
      requestAnimationFrame(() => {
          setTimeout(() => {
              startTime = Date.now();
              waitingForReaction = true;
              startMissTimeout();
          }, 0);
      });

    }, waitTime);
  }

  function startMissTimeout() {
      // â–¼â–¼â–¼ ã“ã“ã‚’ 0.55ç§’ (550ms) ã«è¨­å®šã—ã¾ã—ãŸï¼é¬¼ï¼ â–¼â–¼â–¼
      trialTimeout = setTimeout(() => {
          if(waitingForReaction) {
            waitingForReaction = false;
            
            if(currentTargetIsTarget) {
                missCount++;
                statusMessage.textContent = 'é…ã„ãƒ¯ãƒ³ï¼ãƒŸã‚¹ğŸ’¦'; 
                flashArea('miss-flash'); 
            } else {
                statusMessage.textContent = 'ã‚¹ãƒ«ãƒ¼æˆåŠŸâœ¨';
            }
            // ä½™éŸ»ï¼š0.2ç§’
            setTimeout(nextTrial, 200);
          }
      }, 550); // 0.55ç§’
      // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
  }

  function handleTap(e) {
    if (e.type === 'mousedown' && e.button !== 0) return; 

    e.preventDefault();
    if (!isPlaying || !waitingForReaction) return;

    const endTime = Date.now();
    const reactionTime = (endTime - startTime) / 1000;
    waitingForReaction = false;
    clearTimeout(trialTimeout);

    if (currentTargetIsTarget) {
      reactionTimes.push(reactionTime);
      statusMessage.textContent = 'ãƒŠã‚¤ã‚¹ï¼ ' + reactionTime.toFixed(3) + 'ç§’ğŸ¦´';
      flashArea('hit-flash');
    } else {
      missCount++;
      statusMessage.textContent = 'ãŠæ‰‹ã¤ãï¼ãƒŸã‚¹ğŸ’¦';
      flashArea('miss-flash');
    }
    
    setTimeout(nextTrial, 200);
  }
  
  function flashArea(type) {
      gameArea.classList.add(type);
      setTimeout(() => {
          gameArea.classList.remove(type);
      }, 150);
  }

  function endGame() {
    isPlaying = false;
    startBtn.disabled = false;
    startBtn.classList.add('ready');
    startBtn.textContent = "ã‚‚ã†ä¸€åº¦éŠã¶ğŸ¾";
    
    let avgSpeed = 0;
    if (reactionTimes.length > 0) {
        const sum = reactionTimes.reduce((a, b) => a + b, 0);
        avgSpeed = sum / reactionTimes.length;
    }

    avgSpeedSpan.textContent = avgSpeed.toFixed(3);
    missCountSpan.textContent = missCount;
    resultArea.style.display = 'block';
    statusMessage.textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†ã ãƒ¯ãƒ³ï¼ğŸ‰';
  }
</script>
</body>
</html>
